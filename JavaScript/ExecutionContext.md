# 실행 컨텍스트

## 1. 소스코드의 타입

1. 전역 코드: 전역에 존재하는 소스코드. 전역에 정의된 함수, 클래스 등의 내부 코드는 포함x
2. 함수 코드: 함수 내부에 존재하는 소스코드. 함수 내부에 중첩된 함수, 클래스 등 내부 코드 포함 x
3. eval 코드: eval함수에 인수로 전달되어 실행되는 소스코드.
4. 모듈 코드: 모듈 내부에 존재하는 소스코드. 함수, 클래스 포함 x

-> 소스코드의 타입에 따라 실행 컨텍스트를 생성하는 과정과 관리 내용이 다르다.

## 2. 소스코드의 평가와 실행

자바 스크립트의 소스코드는 평가 과정, 실행 과정으로 나뉘어 실행된다. 평가 과정에는 실행 컨텍스트를 생성하고 변수, 함수 등의 선언문만 먼저 실행하여 변수나 함수 식별자를 키로 실행 컨텍스트가 관리하는 스코프에 등록한다.  
평가 과정이 끝나면 선언문을 제외한 코드가 순차적으로 실행된다.

```javascript
const x = 1;
const y = 2;

function foo(a) {
  const x = 10;
  const y = 20;
  console.log(a + x + y);
}

foo(100);

console.log(x + y);
```

전역 코드 평가 -> 전역 코드 실행 -> 함수 코드 평가 -> 함수 코드 실행

함수가 중첩된 형태라면 실행 컨텍스트는 스택 자료구조로 관리된다. 이를 실행 컨텍스트 스택이라 부른다.

## 3. 렉시컬 환경

_다시합시다_  
렉시컬 환경은 식별자와 식별자에 바인딩된 값, 그리고 상위 스코프에 대한 참조를 기록하는 자료구조이다. (해당 스코프에 존재하는 함수, 변수등의 정보를 저장하는 자료구조인듯?)

### 렉시컬 환경의 구성 컴포넌트

1. 환경 레코드: 식별자 등록, 식별자에 바인딩 된 값을 관리
2. 외부 렉시컬 환경에 대한 참조: 상위 스코프를 가키림 (스코프 체인 구현)

## 4. 코드의 실행 과정

```javascript
var x = 1;
const y = 2;

function foo(a) {
  var x = 3;
  const y = 4;

  function bar(b) {
    const z = 5;
    console.log(a + b + x + y + z);
  }
  bar(10);
}

foo(20);
```

1. 전역 객체 생성
2. 전역 코드 평가
   > 1. 전역 실행 컨텍스트 생성
   > 2. 전역 렉시컬 환경 생성
   > 3. 전역 환경 레코드 생성: 전역 환경 레코드에서 var로 생성한 변수와 함수는 전역 객체의 프로퍼티, 메소드로 객체 환경 레코드(Object Environment Record)에 저장되고 let, const로 생성한 변수는 선언적 환경 레코드(Delarative Environment Record)에 저장된다.
   > 4. 전역 환경 레코드의 전역 코드에서 this는 전역 객체를 가리키므로 [[GlobalThisValue]] 내부 슬롯에는 전역 객체가 바인딩된다.
   > 5. 외부 렉시컬 환경에 대한 참조 결정: 전역 객체이기 때문에 외부 스코프가 없다 (null)
3. 전역 코드 실행: 변수 할당, 함수 호출
4. 함수 코드 평가: 전역 코드의 실행을 일시 중단하고 함수 내부로 코드의 제어권이 이동하여 함수를 평가한다.
   > 1. 함수 실행 컨텍스트 생성: 생성 직후 함수 실행 컨텍스트는 실행 컨텍스트 스택의 최상위가 된다.
   > 2. 함수 렉시컬 환경 생성
   > 3. 함수 환경 레코드 생성: 지역변수, 중첩함수를 등록하고 관리
   > 4. 함수 환경 레코드의 [[ThisValue]] 내부 슬롯에 this가 바인딩된다. 이때 this는 함수 호출 방식에 따라 달라지고 위 코드의 경우 전역 객체를 가리킨다.
   > 5. 외부 렉시컬 환경에 대한 참조 결정: 외부 스코프는 전역 객체이므로 전역 객체를 가리킴(실행된 장소가 아니라 정의된 장소 기준)
5. 함수 코드 실행: 변수 할당문 실행, 값 할당
6. 내부 함수 코드 평가
7. 내부 함수 코드 실행
8. 내부 함수 코드 실행 종료: 실행 컨텍스트가 소멸되어도 다른 객체가 참조하고 있을 경우 렉시컬 환경은 사라지지 않음
9. 함수 코드 종료
10. 전역 코드 실행 종료

## 5. 블록 레벨 스코프 (if문 등을 만났을 때 렉시컬 환경)

만약 코드가 실행중에 if문 등의 함수가 아닌 블록을 만나면 실행 컨텍스트는 그대로 유지하지만 임시로 선언적 환경 레코드를 가진 블록 렉시컬 환경을 생성하고, 블록 렉시컬 환경의 외부 렉시컬 환경 참조에 방금까지 실행중이던 렉시컬 환경을 바인딩한다. 블록문의 실행이 종료되고 난 뒤 다시 실행 컨텍스트는 실행중이던 렉시컬 환경을 가리킨다.
